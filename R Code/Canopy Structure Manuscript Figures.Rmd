---
title: "Canopy Structure Manuscript Figures"
author: "Ro√≠ Ankori-Karlinsky"
date: "9/12/2022"
output:
  html_document:
    toc: true
    toc_depth: 5
    toc_float: true
    theme: journal
---


```{r setup, include=FALSE}

# load packages 

#Basic
library(tidyverse) # Grammar for data manipulation
library(parallel) # mclapply for multicore processing
library(readxl) #load excel

#Data checking
library(naniar) # Visualization of missing values
library(Amelia) # Teting missing columns
library(corrplot) #correlation plots
library(psych) #testing correlations
library(broom) #tidy regressions

#Spatial analyses
library(sp) #provides object oriented classes for spatial data in R 
library(sf) #similar to sp
library(rgdal) # raster analysis
library(raster) #provides classes and methods for raster datasets
library(spdplyr) #spatial data manipulation
library(rgeos) #spatial data plotting

# Visualization
library(ggRandomForests) # ggplot2 random forest figures
library(ggspatial) #visualizing maps
library(gridExtra) # allows plotting of multiple ggplots in one
library(grid) #same as above
library(colorRamps) # Colors for graphing
library(RColorBrewer) # Colors for graphing
library(cowplot) #putting plots together
library(ggpubr) #plots together
library(scales) #Helps with visualization
library(kableExtra) #summary tables
library(colorspace) #color-blind friendly palettes
library(colorBlindness) #color-blind friendly palettes
library(png) #images


# set directories

#File path for most files
local_path <- 'C:/Users/roiak/Documents/Damage Project/Rugosity'

#Directory for GWA data
gwa_dir<- paste0(local_path,'/Data/Final/Wind Models/Global Wind Atlas CFDDA 100m Res Data/')

#Directory for weather station data
station_dir <- paste0(local_path,'/Data/Final/Wind Models/Iowa State Wind Station Data/')

#Where local shapefiles are
shp_dir <- paste0(local_path,'/Data/Shapefiles')

#Where island points are
point_dir <- paste0(shp_dir,"/Island Points/")

#Where plot quadrats are
plot_dir <- paste0(shp_dir, "/Plots")

#Where precipitation data is
prec_dir <- paste0(shp_dir,"/climate_data")

#Where forest age data is
age_dir <- paste0(shp_dir,"/Forest age")

#Where soil data is
soil_dir <- paste0(shp_dir,"/Soils")

#Where DEM is
dem_dir <- paste0(shp_dir,"/DEM")

#Where canopy structure metrics are
csc_dir <- paste0(shp_dir,"/CSC")

#Where wind exposure is
wind_dir <- paste0(shp_dir,"/Wind Exposure")

#Where past hurricane exposure is
hur_dir <- paste0(wind_dir,"/Hurricanes")

#Making sure R is utilizing all available RAM
memory.limit(size=500000)
rasterOptions(maxmemory = 4e+16)
gc()

#Saving figures to file path as png a
knitr::opts_chunk$set(
  echo=F,
  dev = 'png',
  dpi=600,
  fig.path = (paste0(local_path,"/Figures/Canopy Structure Manuscript Final Figures Oct 28/")
)
)

```

```{r data prep, message=FALSE, warning=FALSE,echo=F}

full_d <- read_csv(paste0(local_path,"/Data/Final/Full_Data_For_Analyses.csv"))#data file

#cleaning data
full_d <- full_d %>%
  #Fixing variables (factors, making sure precipitation is in mm/year)
  mutate(Soil = factor(Soil),
         Max_Height = as.numeric(Max_Height),
         Forest_Age = factor(Forest_Age),
         MAP = MAP *0.01,
         Wind_Binary = ifelse(Wind_Binary == 0, "Protected",
                              ifelse(Wind_Binary == 1, "Exposed",NA))
         )  %>%
  #Removing outliers and sites below sea-level
  filter(CHM > 2 & CHM <40, #getting rid of canopy height outliers
         Elev_Mean >=0)

#Fixing wind-exposure
full_d$Wind_Binary <- factor(full_d$Wind_Binary,
                              levels = c("Protected","Exposed"))

#Creating dataset for each response variable
height <- full_d %>%
  dplyr::select(CHM,
                Forest_Age,
                MAP,
                Wind_Binary,
                Elev_Mean,
                Slope,
                Soil,
                AWS_mean) %>%
  na.omit(.)


rugosity <- full_d %>%
  dplyr::select(Rugosity,
                CHM,
                Forest_Age,
                MAP,
                Wind_Binary,
                Elev_Mean,
                Slope,
                Soil,
                AWS_mean) %>%
  na.omit(.)

#Loading GWA Data
gwa_data <- read_csv(paste0(gwa_dir,"Merged_Model_Wind.csv")) %>%
  filter(Site=="Island")

#Loading Weather Station Data
station_data <- read_csv(paste0(station_dir,"WindData from Stations With Speed.csv"),
                         col_types = list(.default = col_double(), 
                                          DateTime = col_character(),
                                          Station = col_character()))

#arranging by station and date
station_data <- station_data %>%
  arrange(Station,DateTime,WindDirection)

#Adding site direction and 12 aspect sector
station_data <- station_data %>%
  filter(!is.na(WindDirection),
         WindDirection != "null") %>%
  mutate(Site_Direction = ifelse(
    Station=="TJBQ","NorthWest",ifelse(
      Station=="TJIG","North",ifelse(
        Station =="TJSJ", "NorthEast",ifelse(
          Station=="TJNR","East",ifelse(
              Station=="TJPS","South",ifelse(
                Station=="TJMZ","West",NA)))))
    ),
    sector = case_when(
      WindDirection %in% 0:29 ~ 1,
      WindDirection %in% 30:59 ~ 2,
      WindDirection %in% 60:89 ~ 3,
      WindDirection %in% 90:119 ~ 4,
      WindDirection %in% 120:149 ~ 5,
      WindDirection %in% 150:179 ~ 6,
      WindDirection %in% 180:209 ~ 7,
      WindDirection %in% 210:239 ~ 8,
      WindDirection %in% 240:269 ~ 9,
      WindDirection %in% 270:299 ~ 10,
      WindDirection %in% 300:329 ~ 11,
      WindDirection %in% 330:360 ~ 12
    )
    )

#cleaning up weather station data
station_clean <- station_data %>%
  #removing years after study site and hurricane season
  mutate(Date = lubridate::as_datetime(station_data$DateTime)) %>%
  mutate(Month = lubridate::month(Date),
         Year = lubridate::year(Date)) %>%
  filter(Year < 2017,
         Month != 6,
         Month != 7,
         Month != 8,
         Month != 9,
         Month != 10,
         Month != 11) %>%
  dplyr::select(Station,sector,WindSpeed,Year,Month) %>%
  rename(Wind_Speed = WindSpeed) %>%
  mutate(Wind_Speed = Wind_Speed * 2.2369) #converting to m/s


#weather stations in luquillo experimental forest
lef_wind <- read_csv('~/Damage Project/Wind and Crowns/Data/Wind/All_Stations_WindData.csv') %>%
  filter(Station != "Bisley") %>%
  mutate(
  lon = case_when(
    Station == "Pico del Este" ~ -65.7638,
    Station == "El Verde" ~ -65.8199,
    Station == "Sabana" ~ -65.7298
  ),
  lat = case_when(
    Station == "Pico del Este" ~ 18.2797,
    Station == "El Verde" ~ 18.3212,
    Station == "Sabana" ~ 18.3249
  )
  )

#cleaning up weather station data
lef_clean <- lef_wind %>%
  #removing years after study site and hurricane season
  mutate(Date = lubridate::as_datetime(lef_wind$Date)) %>%
  mutate(Month = lubridate::month(Date),
         Year = lubridate::year(Date)) %>%
  filter(Year < 2017,
         Year > 2000,
         Month != 6,
         Month != 7,
         Month != 8,
         Month != 9,
         Month != 10,
         Month != 11) %>%
  dplyr::select(Station,sector,Wind_Speed,Year,Month)

#joining together
wind_data <- rbind.data.frame(station_clean,lef_clean) %>%
  arrange(Station,Year,Month,sector)

#getting most common wind directions and joining all weather stations
wind_summary <- wind_data %>%
  group_by(sector) %>%
  summarize(Total_in_sector = sum(sector),
            Wind_Speed = mean(Wind_Speed,na.rm=T)) %>%
  mutate(Total_in_island = sum(Total_in_sector))%>%
  mutate(percent = (Total_in_sector/Total_in_island)*100) %>%
  mutate(sector = sector*30-30) %>%
  arrange(sector)

```


```{r load RF results, message=FALSE, warning=FALSE,echo=F}
# Loading data for height vimp results
RF_height <- read_csv(paste0(local_path,
                             "/Data/Final/Height VIMP.csv"
)) %>%
  # Making VIMP more legible
  mutate(Mean_VIMP = Mean_VIMP*100,
         VIMP_sd = VIMP_sd*100) %>% 
  # Making variable names more legible
  mutate(Variable = case_when(
    Variable == "MAP" ~ "Mean Annual Precipitation (mm/yr)",
    Variable == "Forest_Age" ~ "Forest Age",
    Variable == "Wind_Binary" ~ "Chronic Wind-Exposure",
    Variable == "Elev_Mean" ~ "Elevation (m)",
    Variable == "AWS_mean" ~ "Available Soil Water Storage (cm)",
    Variable == "Slope" ~ "Slope (degrees)",
    Variable == "Soil" ~ "Soil Type",
    Variable == "Hugo_exposure" ~ "Hurricane Hugo Exposure 1989"
    ))

# Loading R2 and error for height model
Height_model <- read_csv(paste0(local_path,
                             "/Data/Final/Height Model.csv"))

# Loading data for rugosity vimp results
RF_rugosity <- read_csv(paste0(local_path,
                             "/Data/Final/Rugosity VIMP.csv"
)) %>%
  # Making VIMP more legible
  mutate(Mean_VIMP = Mean_VIMP*100,
         VIMP_sd = VIMP_sd*100) %>% 
  # Making variable names more legible
  mutate(Variable = case_when(
    Variable == "CHM" ~ "Canopy Height (m)",
    Variable == "MAP" ~ "Mean Annual Precipitation (mm/yr)",
    Variable == "Forest_Age" ~ "Forest Age",
    Variable == "Wind_Binary" ~ "Chronic Wind-Exposure",
    Variable == "Elev_Mean" ~ "Elevation (m)",
    Variable == "AWS_mean" ~ "Available Soil Water Storage (cm)",
    Variable == "Slope" ~ "Slope (degrees)",
    Variable == "Soil" ~ "Soil Type",
    Variable == "Hugo_exposure" ~ "Hurricane Hugo Exposure 1989"
    ))

# Loading R2 and error for rugosity model
Rugosity_model <- read_csv(paste0(local_path,
                             "/Data/Final/Rugosity Model.csv"))

```

```{r load partial predictions, message=FALSE, warning=FALSE, echo=FALSE}

#load height PD
load("C:/Users/roiak/Documents/Damage Project/Rugosity/Data/Final/Height_PD.RData")

#save as object
Height_PD <- gg_p

#clean
rm(gg_p)

#load rugosity PD
load("C:/Users/roiak/Documents/Damage Project/Rugosity/Data/Final/Rugosity_PD.RData")

#save as object
Rugosity_PD <- gg_p

#clean
rm(gg_p)
gc()

```

```{r load PD coplot data, message=FALSE, warning=FALSE}

#canopy height top predictors coplot with wind exposure
load("C:/Users/roiak/Documents/Damage Project/Rugosity/Data/Final/RF_Height_WindPrec.RData")
Height_Rain <- data.frame(partial_coplot) %>%
  mutate(Wind_Binary = case_when(
    group==0 ~"Protected",
    group==1 ~"Exposed")) %>%
  mutate(Wind_Binary = factor(Wind_Binary,
                                levels=c("Protected","Exposed")))

rm(partial_coplot)
  
load("C:/Users/roiak/Documents/Damage Project/Rugosity/Data/Final/RF_Height_WindElev.RData")
Height_Elev <- data.frame(partial_coplot) %>%
  mutate(Wind_Binary = case_when(
    group==0 ~"Protected",
    group==1 ~"Exposed")) %>%
  mutate(Wind_Binary = factor(Wind_Binary,
                                levels=c("Protected","Exposed")))
rm(partial_coplot)

load("C:/Users/roiak/Documents/Damage Project/Rugosity/Data/Final/RF_Height_WindAge.RData")
Height_Age <- data.frame(partial_coplot) %>%
  mutate(Wind_Binary = case_when(
    group==0 ~"Protected",
    group==1 ~"Exposed")) %>%
  mutate(Wind_Binary = factor(Wind_Binary,
                                levels=c("Protected","Exposed")))
rm(partial_coplot)


#canopy rugosity top predictors coplot with wind exposure
load("C:/Users/roiak/Documents/Damage Project/Rugosity/Data/Final/RF_Rugosity_WindHeight.RData")
Rugosity_Height <- data.frame(partial_coplot) %>%
  mutate(Wind_Binary = case_when(
    group==0 ~"Protected",
    group==1 ~"Exposed")) %>%
  mutate(Wind_Binary = factor(Wind_Binary,
                                levels=c("Protected","Exposed")))
rm(partial_coplot)

load("C:/Users/roiak/Documents/Damage Project/Rugosity/Data/Final/RF_Rugosity_WindPrec.RData")
Rugosity_Rain <- data.frame(partial_coplot) %>%
  mutate(Wind_Binary = case_when(
    group==0 ~"Protected",
    group==1 ~"Exposed")) %>%
  mutate(Wind_Binary = factor(Wind_Binary,
                                levels=c("Protected","Exposed")))
rm(partial_coplot)

load("C:/Users/roiak/Documents/Damage Project/Rugosity/Data/Final/RF_Rugosity_WindAge.RData")
Rugosity_Age <- data.frame(partial_coplot) %>%
  mutate(Wind_Binary = case_when(
    group==0 ~"Protected",
    group==1 ~"Exposed")) %>%
  mutate(Wind_Binary = factor(Wind_Binary,
                                levels=c("Protected","Exposed")))
rm(partial_coplot)

load("C:/Users/roiak/Documents/Damage Project/Rugosity/Data/Final/RF_Rugosity_WindElev.RData")
Rugosity_Elev <- data.frame(partial_coplot) %>%
  mutate(Wind_Binary = case_when(
    group==0 ~"Protected",
    group==1 ~"Exposed")) %>%
  mutate(Wind_Binary = factor(Wind_Binary,
                                levels=c("Protected","Exposed")))
rm(partial_coplot)

```

```{r loading interaction data, message=FALSE, warning=FALSE}

height_int <- read_csv(paste0(local_path,
                             "/Data/Final/Height Interaction.csv"
)) %>%
  ungroup() %>%
  # Making columns better names
  rename(Variable = .feature,
         Interaction = .interaction) %>%
  arrange(Interaction) %>%
  mutate(Variable=factor(Variable))

rugosity_int <- read_csv(paste0(local_path,
                             "/Data/Final/Rugosity Interaction.csv"
)) %>%
  ungroup() %>%
  # Making columns better names
  rename(Variable = .feature,
         Interaction = .interaction) %>%
  arrange(Interaction) %>%
  mutate(Variable=factor(Variable))

```

# OVERVIEW

### Questions

  - **(1)** Does chronic exposure to non-hurricane winds reduce canopy structural complexity in tropical forests?  
  - **(2)** To what extent is this effect mediated by climate, topography, substrate, forest age and past disturbances?

### Goals

This script shows results of random forest (RF) models for 2 response variables:

  - **(1)** Canopy Height
  - **(2)** Canopy Top Rugosity (sd of height along moving windows) - Vertical variation for top of canopy  

The results shown are divided into 3 parts:  

  - **(A)** Variable importance (VIMP) ranking of predictors of each response variable.  
        - The VIMP reported is a mean of 10 RF models for each response variable.  
  - **(B)** Relationships between the most important predictors and each response variable.  
        - These are from partial dependence (PD) predictions from the RF, and coplots based on wind-exposure  
  - **(C)** Interactions among predictors based on Friedman's H-Factor
  - **(D)** Data Visualization  
        - Distributions of response variable based on predictors  
        - Summary Tables of response variables  
        - Pearson correlation matrices between all variables  
  - **(E)** Wind Roses of both global wind atlas model and weather station data of prevailing wind directions in PR  
  - **(F)** Maps of study sites and response variables

### Data

The LiDAR data come from 2016 flights by the USGS, which were then normalized by Lora Murphy of the Cary Institute.
Lora also calculated a canopy height model (CHM) and top rugosity.

Study sites were selected by stratified sampling randomly across forest age,
Then creating a required 250m minimum distance between points,
Then creating 30m buffers around to have a scale that captures a forest stand,
Then filtering out non-forest points if they contain non-forest elements within the buffer.

This resulted in 20,660 study sites across Puerto Rico for the 30m buffer.

The independent variables used are:
  - Soil type 
  - Soil water availability
  - Forest age  
  - Wind exposure (calculated with prevalent directions and using a 30m DEM)
  - Elevation mean and range (30m USGS DEM)
  - Slope (30m USGS DEM)
  - Long term mean annual precipitation 1963-1995 (PRISM)  
  - Exposure to hurricane Hugo in 1989 and hurricane Georges in 1998 (Boose et al., 2004)
  
***

# A) Random Forest Results (VIMP)

Height and rugosity

```{r RF VIMP height rugosity, message=FALSE, warning=FALSE,fig.width=7,fig.height=7,dpi=600}

#VIMP for height
a <- RF_height %>%
  arrange(Mean_VIMP) %>%
  mutate(Predictor = factor(Variable,levels=Variable)) %>%
  ggplot(aes(x=Predictor,y=Mean_VIMP))+
  geom_hline(yintercept = median(RF_height$Mean_VIMP),
             linetype="dashed",
             size=0.15)+
  geom_point(size=5, color="blue",
             position=position_dodge(width=0.9))+
  annotate("text",x=3,y=510,
           label=paste("R^2 == 0.40"),
           parse=T,
           colour="black",
           size=6)+
  annotate("text",x=2,y=510,
           label=paste("error == 0.20"),
           parse=T,
           colour="black",
           size=4)+
  coord_flip(ylim=c(0,600))+
  scale_y_continuous(breaks=seq(0,600,200))+
  theme_classic()+
  labs(y="VIMP",x="",title="a)")+
  theme(plot.margin=ggplot2::margin(6,4,2,2),
        plot.title=element_text(colour="black",face="bold",hjust=-0.1,size=16),
        axis.title = element_text(size=18,colour="black",face="bold"),
        axis.text = element_text(size=16,colour="black"))

#VIMP for rugosity
b <- RF_rugosity %>%
  arrange(Mean_VIMP) %>%
  mutate(Predictor = factor(Variable,levels=Variable)) %>%
  ggplot(aes(x=Predictor,y=Mean_VIMP))+
  geom_hline(yintercept = median(RF_rugosity$Mean_VIMP),
             linetype="dashed",
             size=0.15)+
  geom_point(size=5, color="blue",
             position=position_dodge(width=0.9))+
  annotate("text",x=3,y=25.5,
           label=paste("R^2 == 0.38"),
           parse=T,
           colour="black",
           size=6)+
  annotate("text",x=2,y=25.5,
           label=paste("error == 0.006"),
           parse=T,
           colour="black",
           size=4)+
  coord_flip(ylim=c(0,30))+
  scale_y_continuous(breaks=seq(0,30,10))+
  theme_classic()+
  labs(y="VIMP",x="",title="b)")+
  theme(plot.margin=ggplot2::margin(6,4,2,2),
        plot.title=element_text(colour="black",face="bold",hjust=-0.1,size=16),
        axis.title = element_text(size=18,colour="black",face="bold"),
        axis.text = element_text(size=16,colour="black"))
  
#plot together
grid.arrange(a,b)

```

***

# B) Partial Dependence Predictions  

## Canopy Height  

```{r Height PD predictors, message=FALSE, warning=FALSE, fig.height=14,fig.width=8,dpi=600}

#first predictor
a <- data.frame(Height_PD[[1]]) %>%
  ggplot(aes(x=MAP,y=yhat))+
  geom_smooth()+
  geom_point(size=2)+
  coord_cartesian(ylim=c(5,15))+
  scale_x_continuous(breaks=seq(0,4600,1000))+
  scale_y_continuous(breaks=seq(5,15,5))+
  theme_classic()+
  labs(title="a)",
       x="Mean Annual Precipitation (mm/yr)",
       y="Predicted Canopy Height (m)")+
  theme(plot.title=element_text(colour="black",face="bold",hjust=-0.1,size=16),
        axis.title.y = element_blank(),
        axis.title.x = element_text(size=20,face="bold"),
        axis.text = element_text(size=18))

#second predictor
b <- data.frame(Height_PD[[2]]) %>%
  mutate(Forest_Age = case_when(
    Forest_Age == "1" ~ "5-16 yr",
    Forest_Age == "2" ~ "17-25 yr",
    Forest_Age == "3" ~ "26-39 yr",
    Forest_Age == "4" ~ "40-65 yr",
    Forest_Age == "5" ~ "Old Growth"
  )) %>%
  mutate(Forest_Age = factor(Forest_Age,levels = c("5-16 yr",
                               "17-25 yr",
                               "26-39 yr",
                               "40-65 yr",
                               "Old Growth"))) %>%
  ggplot(aes(x=Forest_Age,y=yhat,
             group=Forest_Age))+
  #geom_jitter(alpha=0.01)+
  geom_boxplot(position=position_dodge(width=0.9))+
  coord_cartesian(ylim=c(5,15))+
  scale_y_continuous(breaks=seq(5,15,5))+
  theme_classic()+
  labs(title="b)",
       x="Forest Age",
       y="Predicted Canopy Height (m)")+
  theme(plot.title=element_text(colour="black",face="bold",hjust=-0.1,size=16),
        axis.title.y = element_blank(),
        axis.title.x = element_text(size=20,face="bold"),
        axis.text = element_text(size=18))


#third predictor
c <- data.frame(Height_PD[[3]]) %>%
  mutate(Wind_Exposure = ifelse(Wind_Exposure == 0, "Protected",
                              ifelse(Wind_Exposure == 1, "Exposed",NA))) %>%
  mutate(Wind_Exposure = factor(Wind_Exposure,
                              levels=c("Protected","Exposed"))) %>%
  ggplot(aes(x=Wind_Exposure,y=yhat,group=Wind_Exposure))+
  geom_boxplot(position=position_dodge(width=0.9))+
  coord_cartesian(ylim=c(10,12.55))+
  scale_y_continuous(breaks=seq(10,12.55,1))+
  theme_classic()+
  labs(title="c)",
       x="Chronic Wind-Exposure",
       y="Predicted Canopy Height (m)")+
  theme(plot.title=element_text(colour="black",face="bold",hjust=-0.1,size=16),
        axis.title.y = element_blank(),
        axis.title.x = element_text(size=20,face="bold"),
        axis.text = element_text(size=18))
  
figure5 <- ggarrange(a,b,c, 
                     ncol=1,nrow=3,align="hv",
                     heights = c(4,4,4))+
  theme(plot.margin = ggplot2::margin(t=0.75,r=0.75,b=0.75,l=1,"cm"))


# output to check
# annotate_figure(figure5,
#                 left = text_grob("Predicted Canopy Height (m)",
#                                  color = "black",
#                                  face="bold",
#                                  size=18,
#                                  rot=90,
#                                  vjust = 0.5))

```


```{r Height PD Wind Coplot, message=FALSE, warning=FALSE, fig.height=14,fig.width=8,dpi=600}

d <- Height_Rain %>%
  ggplot(aes(x=MAP,y=yhat,group=Wind_Binary,color=Wind_Binary))+
  geom_point(size=2)+
  geom_smooth()+
  coord_cartesian(ylim=c(5,15))+
  scale_x_continuous(breaks=seq(0,4600,1000))+
  scale_y_continuous(breaks=seq(5,15,5))+
  scale_color_manual(values=c("#005000","#860086"))+
  theme_classic()+
  labs(title="d)",
       x="Mean Annual Precipitation (mm/yr)",
       y="Predicted Canopy Height (m)",
       color="Chronic Wind-Exposure")+
  theme(plot.title=element_text(colour="black",face="bold",hjust=-0.1,size=16),
        axis.title.y = element_blank(),
        axis.title.x = element_text(size=20,face="bold"),
        axis.text = element_text(size=18),
        legend.position = "none",
        legend.text = element_text(size=14),
        legend.title = element_text(size=15))

e <- Height_Age %>%
  mutate(Forest_Age = case_when(
    Forest_Age == "1" ~ "5-16 yr",
    Forest_Age == "2" ~ "17-25 yr",
    Forest_Age == "3" ~ "26-39 yr",
    Forest_Age == "4" ~ "40-65 yr",
    Forest_Age == "5" ~ "Old Growth"
  )) %>%
  mutate(Forest_Age = factor(Forest_Age,levels = c("5-16 yr",
                               "17-25 yr",
                               "26-39 yr",
                               "40-65 yr",
                               "Old Growth"))) %>%
  ggplot(aes(x=Forest_Age,y=yhat,color=Wind_Binary))+
  geom_boxplot(position=position_dodge(width=0.9),
               alpha=0.5,
               notch=T)+
  coord_cartesian(ylim=c(5,15))+
  scale_y_continuous(breaks=seq(5,15,5))+
  scale_color_manual(values=c("#005000","#860086"))+
  theme_classic()+
  labs(title="e)",
       x="Forest Age",
       y="Predicted Canopy Height (m)",
       color="Chronic Wind-Exposure")+
  theme(plot.title=element_text(colour="black",face="bold",hjust=-0.1,size=16),
        axis.title.y = element_blank(),
        axis.title.x = element_text(size=20,face="bold"),
        axis.text = element_text(size=18),
        legend.position = "none")

f <- Height_Elev %>%
  ggplot(aes(x=Elev_Mean,y=yhat,group=Wind_Binary,color=Wind_Binary))+
  geom_point(size=2)+
  geom_smooth()+
  coord_cartesian(ylim=c(5,15))+
  scale_x_continuous(breaks=seq(0,1300,600))+
  scale_y_continuous(breaks=seq(5,15,5))+
  scale_color_manual(values=c("#005000","#860086"))+
  theme_classic()+
  labs(title="f)",
       x="Elevation (m)",
       y="Predicted Canopy Height (m)",
       color="Chronic Wind-Exposure")+
  theme(plot.title=element_text(colour="black",face="bold",hjust=-0.1,size=16),
        axis.title.y = element_blank(),
        axis.title.x = element_text(size=20,face="bold"),
        axis.text = element_text(size=18),
        legend.position = "none")


#group plots together
figure6 <- ggarrange(d,e,f, 
                     ncol=1,nrow=3,align="hv",
                     heights = c(4,4,4),
                     common.legend = T,
                     legend="right")+
  theme(plot.margin = ggplot2::margin(t=0.75,r=0.75,b=0.75,l=1,"cm"))


#output to check
# annotate_figure(figure6,
#                 left = text_grob("Predicted Canopy Height (m)", 
#                                  color = "black",
#                                  face="bold",
#                                  size=18,
#                                  rot=90,
#                                  vjust = 0.5))

```

```{r Height PD and coplot, message=FALSE, warning=FALSE, fig.height=12,fig.width=14,dpi=600}

#combine figures
Fig1 <- ggarrange(a,d,b,e,c,f,
                     ncol=2,nrow=3,align="hv",
                     heights = c(10,10,10),
                     common.legend = T,
                     legend="top")+
  theme(plot.margin = ggplot2::margin(t=0.75,r=0.75,b=0.75,l=1,"cm"))

#output
annotate_figure(Fig1,
                left = text_grob("Predicted Canopy Height (m)", 
                                 color = "black",
                                 face="bold",
                                 size=18,
                                 rot=90,
                                 vjust = 0.5))

#clean
rm(a,b,c,d,e,f)
gc()

```


---

## Canopy Rugosity  

```{r Rugosity PD predictors, message=FALSE, warning=FALSE, fig.height=12,fig.width=14,dpi=600}

#first predictor
a <- data.frame(Rugosity_PD[[1]]) %>%
  ggplot(aes(x=CHM,y=yhat))+
  geom_smooth()+
  geom_point(size=2)+
  coord_cartesian(ylim=c(1.75,3.75))+
  scale_x_continuous(breaks=seq(0,40,10))+
  scale_y_continuous(breaks=seq(1.75,3.75,1))+
  theme_classic()+
  labs(title="a)",
       x="Canopy Height (m)",
       y="Predicted Canopy Top Rugosity (m)")+
  theme(plot.title=element_text(colour="black",face="bold",hjust=-0.1,size=16),
        axis.title.y = element_blank(),
        axis.title.x = element_text(size=20,face="bold"),
        axis.text = element_text(size=18))

#second predictor
b <- data.frame(Rugosity_PD[[2]]) %>%
  ggplot(aes(x=MAP,y=yhat))+
  geom_smooth()+
  geom_point(size=2)+
  coord_cartesian(ylim=c(2.5,3.5))+
  scale_x_continuous(breaks=seq(0,4600,1000))+
  scale_y_continuous(breaks=seq(2.5,3.5,0.5))+
  theme_classic()+
  labs(title="b)",
       x="Mean Annual Precipitation (mm/yr)",
       y="Predicted Canopy Top Rugosity (m)")+
  theme(plot.title=element_text(colour="black",face="bold",hjust=-0.1,size=16),
        axis.title.y = element_blank(),
        axis.title.x = element_text(size=20,face="bold"),
        axis.text = element_text(size=18))

#third predictor
c <- data.frame(Rugosity_PD[[5]]) %>%
  ggplot(aes(x=Elev_Mean,y=yhat))+
  geom_smooth()+
  geom_point(size=2)+
  coord_cartesian(ylim=c(2.5,3.5))+
  scale_y_continuous(breaks=seq(2.5,3.5,0.5))+
  scale_x_continuous(breaks=seq(0,1300,600))+
  theme_classic()+
  labs(title="c)",
       x="Elevation (m)",
       y="Predicted Canopy Top Rugosity (m)")+
  theme(plot.title=element_text(colour="black",face="bold",hjust=-0.1,size=16),
        axis.title.y = element_blank(),
        axis.title.x = element_text(size=20,face="bold"),
        axis.text = element_text(size=18))

#fourth predictor
d <- data.frame(Rugosity_PD[[3]]) %>%
  mutate(Forest_Age = case_when(
    Forest_Age == "1" ~ "5-16 yr",
    Forest_Age == "2" ~ "17-25 yr",
    Forest_Age == "3" ~ "26-39 yr",
    Forest_Age == "4" ~ "40-65 yr",
    Forest_Age == "5" ~ "Old Growth"
  )) %>%
  mutate(Forest_Age = factor(Forest_Age,levels = c("5-16 yr",
                               "17-25 yr",
                               "26-39 yr",
                               "40-65 yr",
                               "Old Growth"))) %>%
  ggplot(aes(x=Forest_Age,y=yhat,
             group=Forest_Age))+
  geom_boxplot(position=position_dodge(width=0.9))+
  coord_cartesian(ylim=c(2.75,3.5))+
  scale_y_continuous(breaks=seq(2.75,3.5,0.25))+
  theme_classic()+
  labs(title="d)",
       x="Forest Age",
       y="Predicted Canopy Top Rugosity (m)")+
  theme(plot.title=element_text(colour="black",face="bold",hjust=-0.1,size=16),
        axis.title.y = element_blank(),
        axis.title.x = element_text(size=20,face="bold"),
        axis.text = element_text(size=18))

#Plot together
figure7 <- ggarrange(a,b,c,d,
                     ncol=2,nrow=2,align="hv",
                     heights = c(4,4,4,4))+
  theme(plot.margin = ggplot2::margin(t=0.75,r=0.75,b=0.75,l=1,"cm"))


# #output to check
# annotate_figure(figure7,
#                 left = text_grob("Predicted Canopy Top Rugosity (m)", 
#                                  color = "black",
#                                  face="bold",
#                                  size=20,
#                                  rot=90,
#                                  vjust = 0.5))
```


```{r Rugosity PD Wind Coplot, message=FALSE, warning=FALSE, fig.height=14,fig.width=14,dpi=600}

#first predictor
e <- Rugosity_Height %>%
  ggplot(aes(x=CHM,y=yhat,group=Wind_Binary,color=Wind_Binary))+
  geom_smooth()+
  geom_point(size=2)+
  coord_cartesian(ylim=c(1.75,3.75))+
  scale_x_continuous(breaks=seq(0,40,10))+
  scale_y_continuous(breaks=seq(1.75,3.75,1))+
  scale_color_manual(values=c("#005000","#860086"))+
  theme_classic()+
  labs(title="e)",
       x="Canopy Height (m)",
       y="Predicted Canopy Top Rugosity (m)",
       color="Chronic Wind-Exposure")+
  theme(plot.title=element_text(colour="black",face="bold",hjust=-0.1,size=16),
        axis.title.y = element_blank(),
        axis.title.x = element_text(size=20,face="bold"),
        axis.text = element_text(size=18),
        legend.position = "none",
        legend.text = element_text(size=14),
        legend.title = element_text(size=15))

#second predictor
f <- Rugosity_Rain %>%
  ggplot(aes(x=MAP,y=yhat,group=Wind_Binary,color=Wind_Binary))+
  geom_smooth()+
  geom_point(size=2)+
  coord_cartesian(ylim=c(2.5,3.5))+
  scale_x_continuous(breaks=seq(0,4600,1000))+
  scale_y_continuous(breaks=seq(2.5,3.5,0.5))+
  scale_color_manual(values=c("#005000","#860086"))+
  theme_classic()+
  labs(title="f)",
       x="Mean Annual Precipitation (mm/yr)",
       y="Predicted Canopy Top Rugosity (m)",
       color="Chronic Wind-Exposure")+
  theme(plot.title=element_text(colour="black",face="bold",hjust=-0.1,size=16),
        axis.title.y = element_blank(),
        axis.title.x = element_text(size=20,face="bold"),
        axis.text = element_text(size=18),
        legend.position = "none")

#third predictor
g <- Rugosity_Elev %>%
  ggplot(aes(x=Elev_Mean,y=yhat,group=Wind_Binary,color=Wind_Binary))+
  geom_smooth()+
  geom_point(size=2)+
  coord_cartesian(ylim=c(2.5,3.75))+
  scale_y_continuous(breaks=seq(2.5,3.75,0.5))+
  scale_x_continuous(breaks=seq(0,1300,600))+
  scale_color_manual(values=c("#005000","#860086"))+
  theme_classic()+
  labs(title="g)",
       x="Elevation (m)",
       y="Predicted Canopy Top Rugosity (m)",
       color="Chronic Wind-Exposure")+
  theme(plot.title=element_text(colour="black",face="bold",hjust=-0.1,size=16),
        axis.title.y = element_blank(),
        axis.title.x = element_text(size=20,face="bold"),
        axis.text = element_text(size=18),
        legend.position = "none")

#fourth predictor
h <- Rugosity_Age %>%
  mutate(Forest_Age = case_when(
    Forest_Age == "1" ~ "5-16 yr",
    Forest_Age == "2" ~ "17-25 yr",
    Forest_Age == "3" ~ "26-39 yr",
    Forest_Age == "4" ~ "40-65 yr",
    Forest_Age == "5" ~ "Old Growth"
  )) %>%
  mutate(Forest_Age = factor(Forest_Age,levels = c("5-16 yr",
                               "17-25 yr",
                               "26-39 yr",
                               "40-65 yr",
                               "Old Growth"))) %>%
  ggplot(aes(x=Forest_Age,y=yhat,color=Wind_Binary))+
  geom_boxplot(position=position_dodge(width=0.9))+
  coord_cartesian(ylim=c(2.5,3.5))+
  scale_y_continuous(breaks=seq(2.5,3.5,0.25))+
  scale_color_manual(values=c("#005000","#860086"))+
  theme_classic()+
  labs(title="h)",
       x="Forest Age",
       y="Predicted Canopy Top Rugosity (m)",
       color="Chronic Wind-Exposure")+
  theme(plot.title=element_text(colour="black",face="bold",hjust=-0.1,size=16),
        axis.title.y = element_blank(),
        axis.title.x = element_text(size=20,face="bold"),
        axis.text = element_text(size=18),
        legend.position="none")

#Plot together
Fig2 <- ggarrange(a,e,b,f,c,g,d,h,
                     ncol=2,nrow=4,align="hv",
                     heights = c(10,10,10,10),
                     common.legend = T,
                     legend = "top")+
  theme(plot.margin = ggplot2::margin(t=0.75,r=0.75,b=0.75,l=1,"cm"))


#output
annotate_figure(Fig2,
                left = text_grob("Predicted Top Rugosity (m)", 
                                 color = "black",
                                 face="bold",
                                 size=20,
                                 rot=90,
                                 vjust = 0.5))

#clean
rm(a,b,c,d,e,f,g,h)
gc()

```


***

# C) Model Interactions  

```{r plotting RF interactions, message=FALSE, warning=FALSE, fig.width=12,fig.height=12,dpi=600}

a <- height_int %>%
  arrange(Interaction) %>%
  ggplot(aes(x=reorder(Variable,Interaction),y=Interaction))+
  geom_point(size=10, color="orange")+
  geom_segment(aes(xend=Variable,yend=0))+
  annotate("text",x=3,y=0.25,
           label=paste("lambda == 0.11"),
           parse=T,
           colour="black",
           size=6)+
  annotate("text",x=2,y=0.25,
           label=paste("error == 21.2"),
           parse=T,
           colour="black",
           size=6)+
  coord_flip(ylim=c(0,0.3))+
  scale_y_continuous(breaks=seq(0,0.3,0.15))+
  theme_classic()+
  labs(y="",x="",title="a)")+
  theme(plot.margin=ggplot2::margin(6,4,2,2),
        plot.title=element_text(colour="black",face="bold",hjust=-0.1,size=16),
        axis.title = element_text(size=18,colour="black",face="bold"),
        axis.text = element_text(size=18,colour="black"))

b <- rugosity_int %>%
  arrange(Interaction) %>%
  ggplot(aes(x=reorder(Variable,Interaction),y=Interaction))+
  geom_point(size=10, color="orange")+
  geom_segment(aes(xend=Variable,yend=0))+
  annotate("text",x=3,y=0.25,
           label=paste("lambda == 0.008"),
           parse=T,
           colour="black",
           size=6)+
  annotate("text",x=2,y=0.25,
           label=paste("error == 0.68"),
           parse=T,
           colour="black",
           size=6)+
  coord_flip(ylim=c(0,0.3))+
  scale_y_continuous(breaks=seq(0,0.3,0.15))+
  theme_classic()+
  labs(y="",x="",title="b)")+
  theme(plot.margin=ggplot2::margin(6,4,2,2),
        plot.title=element_text(colour="black",face="bold",hjust=-0.1,size=16),
        axis.title = element_text(size=18,colour="black",face="bold"),
        axis.text = element_text(size=18,colour="black"))

#plot together
grid.arrange(a,b)

#clean
rm(a,b)
gc()

```


***

# D) Data Visualization  

## Summary Tables  

### Observed and predicted means for height and rugosity for all sites

```{r Summary Table all, message=FALSE, warning=FALSE}

#raw data mean and sds of height and rugosity by wind exposure
raw_sum <- rugosity %>%
  rename(Wind_Exposure = Wind_Binary) %>%
  filter(Rugosity>0 & Rugosity <8,
         CHM>2 & CHM<40,
         !is.na(Wind_Exposure),
         !is.na(Soil),
         !is.na(Forest_Age),
         Soil!="Water") %>% #removing outliers
  group_by(Wind_Exposure) %>% #group by wind
  dplyr::summarise(Mean_Height = round(mean(CHM,na.rm=T),2),
                   Height_sd = round(sd(CHM,na.rm=T),2),
                   Mean_Rugosity = round(mean(Rugosity,na.rm=T),2),
                   Rugosity_sd = round(sd(Rugosity,na.rm=T),2),
                   n = n()) %>%
  mutate(Height_ste = round(Height_sd / sqrt(n),2),
                   Rugosity_ste = round(Rugosity_sd / sqrt(n),2)) %>%
  dplyr::select(-Height_sd,-Rugosity_sd)

#model means and standard errors
height_sum <- Height_PD[[3]] %>%
  group_by(Wind_Exposure) %>%
  dplyr::summarise(Model_Height = round(mean(yhat,na.rm=T),2),
                   Model_height_sd = round(sd(yhat,na.rm=T),2)) %>%
  mutate(Wind_Exposure = case_when(
    Wind_Exposure == 0 ~ "Protected",
    Wind_Exposure == 1 ~ "Exposed"
  )) 

rugosity_sum <- Rugosity_PD[[4]] %>%
  group_by(Wind_Exposure) %>%
  dplyr::summarise(Model_Rugosity = round(mean(yhat,na.rm=T),2),
                   Model_rug_sd = round(sd(yhat,na.rm=T),2)) %>%
  mutate(Wind_Exposure = case_when(
    Wind_Exposure == 0 ~ "Protected",
    Wind_Exposure == 1 ~ "Exposed"
  ))

model_sum <- merge.data.frame(height_sum,rugosity_sum) %>%
  dplyr::distinct_all(.)

rm(rugosity_sum,height_sum)

#merge model and raw data together
sum_table <- merge.data.frame(raw_sum,model_sum)

#order
sum_table <- sum_table %>%
  relocate(Wind_Exposure,Mean_Height,Height_ste,Model_Height,Model_height_sd,
           Mean_Rugosity,Rugosity_ste,Model_Rugosity,Model_rug_sd) %>%
  rename(`Wind-Exposure` = Wind_Exposure) %>%
  distinct_all(.keep_all = F)

kable(sum_table)

```

### Observed means for height and rugosity by forest age

```{r Summary Table forest age observed, message=FALSE, warning=FALSE}

#raw data mean and sds of height and rugosity by wind exposure
raw_sum <- rugosity %>%
  filter(Rugosity>0 & Rugosity <8,
         CHM>2 & CHM<40,
         !is.na(Wind_Binary),
         !is.na(Soil),
         !is.na(Forest_Age),
         Soil!="Water") %>% #removing outliers
  mutate(Forest_Age = factor(Forest_Age,
                             labels =c("5-16 yr",
                              "17-25 yr",
                              "26-39 yr",
                              "40-65 yr",
                              "Old growth"))) %>%
  group_by(Forest_Age, Wind_Binary) %>% #group by wind and age
  dplyr::summarise(Mean_Height = round(mean(CHM,na.rm=T),2),
                   Height_sd = round(sd(CHM,na.rm=T),2),
                   Mean_Rugosity = round(mean(Rugosity,na.rm=T),2),
                   Rugosity_sd = round(sd(Rugosity,na.rm=T),2),
                   n = n()) %>%
  mutate(Height_ste = round(Height_sd / sqrt(n),2),
                   Rugosity_ste = round(Rugosity_sd / sqrt(n),2)) %>%
  dplyr::select(-Height_sd,-Rugosity_sd) %>%
  relocate(Forest_Age,Wind_Binary,Mean_Height,Height_ste,Mean_Rugosity,Rugosity_ste,n) %>%
  rename(`Wind-Exposure` = Wind_Binary)

kable(raw_sum)


```

### Predicted means for height and rugosity by forest age

```{r Summary Table forest age predicted, message=FALSE, warning=FALSE}
Height_sum <- Height_Age %>%
  mutate(Forest_Age = case_when(
    Forest_Age == "1" ~ "5-16 yr",
    Forest_Age == "2" ~ "17-25 yr",
    Forest_Age == "3" ~ "26-39 yr",
    Forest_Age == "4" ~ "40-65 yr",
    Forest_Age == "5" ~ "Old growth"
  )) %>%
  mutate(Forest_Age = factor(Forest_Age,levels = c("5-16 yr",
                               "17-25 yr",
                               "26-39 yr",
                               "40-65 yr",
                               "Old growth"))) %>%
  group_by(Forest_Age, Wind_Binary) %>%
  dplyr::summarise(Predicted_Height = round(mean(yhat,na.rm=T),2),
                   Height_sd = round(sd(yhat,na.rm=T),2))


kable(Height_sum)

Rugosity_sum <- Rugosity_Age %>%
  mutate(Forest_Age = case_when(
    Forest_Age == "1" ~ "5-16 yr",
    Forest_Age == "2" ~ "17-25 yr",
    Forest_Age == "3" ~ "26-39 yr",
    Forest_Age == "4" ~ "40-65 yr",
    Forest_Age == "5" ~ "Old growth"
  )) %>%
  mutate(Forest_Age = factor(Forest_Age,levels = c("5-16 yr",
                               "17-25 yr",
                               "26-39 yr",
                               "40-65 yr",
                               "Old growth"))) %>%
  group_by(Forest_Age, Wind_Binary) %>%
  dplyr::summarise(Predicted_Rugosity = round(mean(yhat,na.rm=T),2),
                   Rugosity_sd = round(sd(yhat,na.rm=T),2))

kable(Rugosity_sum)

```

---

## Distributions  


### Distribution of canopy height by wind-exposure and top predictors 

```{r Canopy Height Wind and Predictor Distribution, message=FALSE, warning=FALSE,fig.height=10,fig.width=16, dpi=600}

#precipitation
a <- height %>%
  filter(Elev_Mean >0,
         CHM>2 & CHM<40,
         !is.na(Wind_Binary),
         MAP > 0)%>% #removing outliers
  mutate(MAP_cuts = cut(MAP, breaks=quantile(MAP,probs=seq(0,1,0.2)), 
                         labels=c("700-1500mm/yr","1500-1700mm/yr",
                                  "1700-1900mm/yr","1900-2100mm/yr","2100-4500mm/yr"))) %>%
  filter(!is.na(MAP_cuts)) %>%
  ggplot(aes(x=CHM,group=Wind_Binary,fill=Wind_Binary))+
  geom_histogram(alpha=0.8,
                 position="identity",
                 bins=20)+
  scale_fill_manual(values=c("#005000","#860086"))+
  facet_wrap(~MAP_cuts,scales="free_x",
             ncol=3)+
  theme_classic()+
  coord_equal(xlim=c(0,40))+
  scale_x_continuous(breaks=seq(0,40,10))+
  scale_y_continuous(n.breaks = 3)+
  coord_flip()+
  labs(title="a)", 
       x="Canopy Height (m)",
       y="# Sites",
       fill = "Chronic Wind-Exposure")+
  theme(plot.margin=ggplot2::margin(6,4,2,2),
        plot.title=element_text(colour="black",face="bold",hjust=-0.1,size=16),
        axis.title = element_blank(),
        axis.text = element_text(size=18),
        strip.text = element_text(size=14,face="bold"),
        legend.text = element_text(size=14),
        legend.title = element_text(size=15))

#forest age
b <- height %>%
  filter(CHM>2 & CHM<40,
         !is.na(Wind_Binary),
         !is.na(Soil),
         !is.na(Forest_Age),
         Soil!="Water")%>% #removing outliers
  mutate(Forest_Age = factor(Forest_Age,
                             labels =c("5-16 yr",
                              "17-25 yr",
                              "26-39 yr",
                              "40-65 yr",
                              "Old growth"))) %>%
  ggplot(aes(x=CHM,group=Wind_Binary,fill=Wind_Binary))+
  geom_histogram(alpha=0.8,
                 position="identity",
                 bins=20)+
  scale_fill_manual(values=c("#005000","#860086"))+
  facet_wrap(~Forest_Age,scales="free_x",
             ncol=3)+
  theme_classic()+
  coord_equal(xlim=c(0,40))+
  scale_x_continuous(breaks=seq(0,40,10))+
  scale_y_continuous(n.breaks = 3)+
  coord_flip()+
  labs(title= "b)",
       x="Canopy Height (m)",
       y="# Sites",
       fill = "Chronic Wind-Exposure")+
  theme(plot.margin=ggplot2::margin(6,4,2,2),
        plot.title=element_text(colour="black",face="bold",hjust=-0.1,size=16),
        axis.title = element_blank(),
        axis.text = element_text(size=18),
        strip.text = element_text(size=14,face="bold"),
        legend.text = element_text(size=14),
        legend.title = element_text(size=15))

#elevation
c <- height %>%
  filter(Elev_Mean >0,
         CHM>2 & CHM<40,
         !is.na(Wind_Binary))%>% #removing outliers
  mutate(Elev_cuts = cut(Elev_Mean, breaks=quantile(Elev_Mean,probs=seq(0,1,0.2)), 
                         labels=c("0-80m","80-170m","170-280m","280-460m","460-1280m"))) %>%
  filter(!is.na(Elev_cuts)) %>%
  ggplot(aes(x=CHM,group=Wind_Binary,fill=Wind_Binary))+
  geom_histogram(alpha=0.8,
                 position="identity",
                 bins=20)+
  scale_fill_manual(values=c("#005000","#860086"))+
  facet_wrap(~Elev_cuts,scales="free_x",
             ncol=3)+
  theme_classic()+
  coord_equal(xlim=c(0,40))+
  scale_x_continuous(breaks=seq(0,40,10))+
  scale_y_continuous(n.breaks = 3)+
  coord_flip()+
  labs(title = "c)",
       x="Canopy Height (m)",
       y="# Sites",
       fill = "Chronic Wind-Exposure")+
  theme(plot.margin=ggplot2::margin(6,4,2,2),
        plot.title=element_text(colour="black",face="bold",hjust=-0.1,size=16),
        axis.title = element_blank(),
        axis.text = element_text(size=18),
        strip.text = element_text(size=14,face="bold"),
        legend.text = element_text(size=14),
        legend.title = element_text(size=15))

# extract the legend from one of the plots
legend <- get_legend(
  # create some space to the left of the legend
  a + theme(legend.box.margin = ggplot2::margin(0, 0, 0, 12))
)

Fig3 <- cowplot::plot_grid(a+theme(legend.position = "none"),
                               b+theme(legend.position = "none"),
                               c+theme(legend.position = "none"),
                           ncol=2,align="hv")+
  theme(plot.margin = ggplot2::margin(t=0.75,r=1.75,b=0.75,l=1.75,"cm"))


cowplot::plot_grid(Fig3, legend, rel_widths = c(3, .4))

#output
annotate_figure(Fig3,
                bottom = text_grob("# Sites", 
                                 color = "black",
                                 face="bold",
                                 size=20,
                                 vjust=-0.5),
                left = text_grob("Canopy Height (m)", 
                                 color = "black",
                                 face="bold",
                                 size=20,rot=90,
                                 vjust=0.5),
                top = legend
                )

```


### Top Rugosity and Height relationships by wind-exposure and top predictors 

```{r rugosity and height by precipitation,message=FALSE, warning=FALSE, fig.width=12,fig.height=18, dpi=600}

#creating regression of height and rugosity by wind exposure broken by precipitation quantiles
rug_prec_reg <- rugosity %>%
  filter(Elev_Mean >0,
         Rugosity>0 & Rugosity<6,
         !is.na(Wind_Binary),
         MAP > 0,
         CHM >2 & CHM<40,
         !is.na(Soil),
         !is.na(Forest_Age),
         Soil!="Water")%>% #removing outliers
  mutate(MAP_cuts = cut(MAP, breaks=quantile(MAP,probs=seq(0,1,0.2)), 
                         labels=c("700-1500mm/yr","1500-1700mm/yr",
                                  "1700-1900mm/yr","1900-2100mm/yr","2100-4500mm/yr"))) %>%
  filter(!is.na(MAP_cuts)) %>%
  dplyr::select(Rugosity,CHM,MAP_cuts,Wind_Binary) %>%
  nest(-MAP_cuts,-Wind_Binary) %>% 
  mutate(
    fit = map(data,
              ~ lm(log(Rugosity) ~ log(CHM),
                        data = .)),
    tidied = map(fit, tidy),
    glanced = map(fit, glance),
    augmented = map(fit, augment)
  )

#getting r2, p-value, residual error, and sample size
model_stats <- rug_prec_reg %>%
  unnest(glanced) %>%  
  #making names better
  rename(R2 = adj.r.squared,
         p = p.value,
         n = nobs)

#mapping relationship with model coefficients
a <- rug_prec_reg %>%
  #unnesting model
  unnest(augmented) %>%
  #plotting
  ggplot(aes(x=exp(`log(CHM)`),y=exp(`log(Rugosity)`)))+
  geom_point(alpha=0.8,aes(color=Wind_Binary))+
  theme_classic()+
  #grid view
  facet_wrap(MAP_cuts~Wind_Binary,
             ncol=2)+
  scale_x_continuous(breaks= scales::pretty_breaks(n=3))+
  #adding model fit
  geom_ribbon(aes(ymin=exp(.fitted)-exp(.sigma),
                  ymax=exp(.fitted)+exp(.sigma)),
              alpha=0.3,
              fill="grey")+
  scale_color_manual(values=c("#005000","#860086"))+
  scale_fill_manual(values=c("#005000","#860086"))+
  #showing model fit
  geom_smooth(method="lm",formula = (y ~ log(x)),se=F,scales="free_x",
              aes(color=Wind_Binary,fill=Wind_Binary))+
  #axes labels
  labs(title="a)",
       x = "",
       y = "",
       color = "Wind-Exposure",
       fill = "Wind-Exposure")+
  #adding labels of model fit
  geom_text(
            aes(x=25,y=1.35,
                label = paste("R^2 == ", round(R2,2)),
                color=Wind_Binary
              ),
    show.legend = F,hjust=0.5,parse=T,size=6,fontface="bold",
    data=model_stats
    ) +
  geom_text(
            aes(x=25,y=0.65,
                label = paste("p == ", round(p,3)),
                color=Wind_Binary
              ),
    show.legend = F,hjust=0.5,parse=T,size=5,fontface="bold",
    data=model_stats
    ) +
  geom_text(
            aes(x=25,y=0.15,
                label = paste("n == ", n),
                color=Wind_Binary
              ),
    show.legend = F,hjust=0.5,parse=T,size=5,fontface="bold",
    data=model_stats
    ) +
  #formatting
  theme(plot.margin=ggplot2::margin(6,4,2,2),
        plot.title=element_text(colour="black",face="bold",hjust=-0.1,size=16),
        axis.title = element_text(color = "black",
                                 face="bold",
                                 size=20,vjust=-0.5),
        axis.text = element_text(size=18),
        strip.text = element_text(size=14,face="bold"),
        legend.position = "top",
        legend.text = element_text(size=14),
        legend.title = element_text(size=15))

#output
#a


```


```{r rugosity and height by elevation,message=FALSE, warning=FALSE, fig.width=12,fig.height=18, dpi=600}

#creating regression of height and rugosity by wind exposure broken by elevation quantiles
rug_elev_reg <- rugosity %>%
  filter(Elev_Mean >0,
         Rugosity>0 & Rugosity<6,
         !is.na(Wind_Binary),
         MAP > 0,
         CHM >2 & CHM<40,
         !is.na(Soil),
         !is.na(Forest_Age),
         Soil!="Water")%>% #removing outliers
  mutate(Elev_cuts = cut(Elev_Mean, breaks=quantile(Elev_Mean,probs=seq(0,1,0.2)), 
                         labels=c("0-80m","80-170m","170-280m","280-460m","460-1280m"))) %>%
  filter(!is.na(Elev_cuts)) %>%
  dplyr::select(Rugosity,CHM,Elev_cuts,Wind_Binary) %>%
  nest(-Elev_cuts,-Wind_Binary) %>% 
  mutate(
    fit = map(data,
              ~ lm(log(Rugosity) ~ log(CHM),
                        data = .)),
    tidied = map(fit, tidy),
    glanced = map(fit, glance),
    augmented = map(fit, augment)
  )

#getting r2, p-value, residual error, and sample size
model_stats <- rug_elev_reg %>%
  unnest(glanced) %>%  
  #making names better
  rename(R2 = adj.r.squared,
         p = p.value,
         n = nobs)

#mapping relationship with model coefficients
b <- rug_elev_reg %>%
  #unnesting model
  unnest(augmented) %>%
  #plotting
  ggplot(aes(x=exp(`log(CHM)`),y=exp(`log(Rugosity)`)))+
  geom_point(alpha=0.8,aes(color=Wind_Binary))+
  theme_classic()+
  #grid view
  facet_wrap(Elev_cuts~Wind_Binary,
             ncol=2)+
  scale_x_continuous(breaks= scales::pretty_breaks(n=3))+
  #adding model fit
  geom_ribbon(aes(ymin=exp(.fitted)-exp(.sigma),
                  ymax=exp(.fitted)+exp(.sigma)),
              alpha=0.3,
              fill="grey")+
  scale_color_manual(values=c("#005000","#860086"))+
  scale_fill_manual(values=c("#005000","#860086"))+
  #showing model fit
  geom_smooth(method="lm",formula = (y ~ log(x)),se=F,scales="free_x",
              aes(color=Wind_Binary,fill=Wind_Binary))+
  #axes labels
  labs(title="b)",
       x = "",
       y = "",
       color = "Wind-Exposure",
       fill = "Wind-Exposure")+
  #adding labels of model fit
  geom_text(
            aes(x=25,y=1.35,
                label = paste("R^2 == ", round(R2,2)),
                color=Wind_Binary
              ),
    show.legend = F,hjust=0.5,parse=T,size=6,fontface="bold",
    data=model_stats
    ) +
  geom_text(
            aes(x=25,y=0.65,
                label = paste("p == ", round(p,3)),
                color=Wind_Binary
              ),
    show.legend = F,hjust=0.5,parse=T,size=5,fontface="bold",
    data=model_stats
    ) +
  geom_text(
            aes(x=25,y=0.15,
                label = paste("n == ", n),
                color=Wind_Binary
              ),
    show.legend = F,hjust=0.5,parse=T,size=5,fontface="bold",
    data=model_stats
    ) +
  #formatting
  theme(plot.margin=ggplot2::margin(6,4,2,2),
        plot.title=element_text(colour="black",face="bold",hjust=-0.1,size=16),
        axis.title = element_text(color = "black",
                                 face="bold",
                                 size=20,vjust=-0.5),
        axis.text = element_text(size=18),
        strip.text = element_text(size=14,face="bold"),
        legend.position = "top",
        legend.text = element_text(size=14),
        legend.title = element_text(size=15))

#output
#b


```


```{r rugosity and height by age,message=FALSE, warning=FALSE, fig.width=12,fig.height=18, dpi=600}

#creating regression of height and rugosity by wind exposure broken by forest age
rug_age_reg <- rugosity %>%
  filter(Elev_Mean >0,
         Rugosity>0 & Rugosity<6,
         !is.na(Wind_Binary),
         MAP > 0,
         CHM >2 & CHM<40,
         !is.na(Soil),
         !is.na(Forest_Age),
         Soil!="Water")%>% #removing outliers
  mutate(Forest_Age = factor(Forest_Age,
                             labels =c("5-16 yr",
                              "17-25 yr",
                              "26-39 yr",
                              "40-65 yr",
                              "Old growth"))) %>%
  dplyr::select(Rugosity,CHM,Forest_Age,Wind_Binary) %>%
  nest(-Forest_Age,-Wind_Binary) %>% 
  mutate(
    fit = map(data,
              ~ lm(log(Rugosity) ~ log(CHM),
                        data = .)),
    tidied = map(fit, tidy),
    glanced = map(fit, glance),
    augmented = map(fit, augment)
  )

#getting r2, p-value, residual error, and sample size
model_stats <- rug_age_reg %>%
  unnest(glanced) %>%  
  #making names better
  rename(R2 = adj.r.squared,
         p = p.value,
         n = nobs)

#mapping relationship with model coefficients
c <- rug_age_reg %>%
  #unnesting model
  unnest(augmented) %>%
  #plotting
  ggplot(aes(x=exp(`log(CHM)`),y=exp(`log(Rugosity)`)))+
  geom_point(alpha=0.8,aes(color=Wind_Binary))+
  theme_classic()+
  #grid view
  facet_wrap(Forest_Age~Wind_Binary,
             ncol=2)+
  scale_x_continuous(breaks= scales::pretty_breaks(n=3))+
  #adding model fit
  geom_ribbon(aes(ymin=exp(.fitted)-exp(.sigma),
                  ymax=exp(.fitted)+exp(.sigma)),
              alpha=0.3,
              fill="grey")+
  scale_color_manual(values=c("#005000","#860086"))+
  scale_fill_manual(values=c("#005000","#860086"))+
  #showing model fit
  geom_smooth(method="lm",formula = (y ~ log(x)),se=F,scales="free_x",
              aes(color=Wind_Binary,fill=Wind_Binary))+
  #axes labels
  labs(title="c)",
       x = "",
       y = "",
       color = "Wind-Exposure",
       fill = "Wind-Exposure")+
  #adding labels of model fit
  geom_text(
            aes(x=25,y=1.35,
                label = paste("R^2 == ", round(R2,2)),
                color=Wind_Binary
              ),
    show.legend = F,hjust=0.5,parse=T,size=6,fontface="bold",
    data=model_stats
    ) +
  geom_text(
            aes(x=25,y=0.65,
                label = paste("p == ", round(p,3)),
                color=Wind_Binary
              ),
    show.legend = F,hjust=0.5,parse=T,size=5,fontface="bold",
    data=model_stats
    ) +
  geom_text(
            aes(x=25,y=0.15,
                label = paste("n == ", n),
                color=Wind_Binary
              ),
    show.legend = F,hjust=0.5,parse=T,size=5,fontface="bold",
    data=model_stats
    ) +
  #formatting
  theme(plot.margin=ggplot2::margin(6,4,2,2),
        plot.title=element_text(colour="black",face="bold",hjust=-0.1,size=16),
        axis.title = element_text(color = "black",
                                 face="bold",
                                 size=20,vjust=-0.5),
        axis.text = element_text(size=18),
        strip.text = element_text(size=14,face="bold"),
        legend.position = "top",
        legend.text = element_text(size=14),
        legend.title = element_text(size=15))

#output
#c


```


```{r Canopy Rugosity and height by Top predictors,message=FALSE, warning=FALSE, fig.height=16,fig.width=22, dpi=600}

# extract the legend from one of the plots
legend <- get_legend(
  # create some space to the left of the legend
  a + theme(legend.box.margin = ggplot2::margin(0, 0, 0, 12))
)

#combining plots
Fig4 <- cowplot::plot_grid(a+theme(legend.position = "none"),
                               b+theme(legend.position = "none"),
                               c+theme(legend.position = "none"),
                           ncol=3,align="hv")+
  theme(plot.margin = ggplot2::margin(t=0.75,r=2.75,b=0.75,l=2.75,"cm"))


#output
annotate_figure(Fig4,
                top = legend,
                bottom = text_grob("Canopy Height (m)", 
                                 color = "black",
                                 face="bold",
                                 size=24,
                                 vjust=0),
                left = text_grob("Top Ruogisty (m)", 
                                 color = "black",
                                 face="bold",
                                 size=24,rot=90,
                                 vjust=0.5),
                )
```


```{r cleaning stuff,message=FALSE,warning=FALSE}

rm(Height_Age,Height_Elev,Height_Rain,Height_PD,
   Rugosity_Age,Rugosity_Elev,Rugosity_Height,Rugosity_Rain,Rugosity_PD)

gc()

```


---

## Pearson Correlations  

### Response Variables  

```{r Correlation of CSC metrics, message=FALSE, warning=FALSE,dpi=600}

#subsetting data
corey <- rugosity %>%
  dplyr::select(CHM,
                Rugosity)

#Creating Pearson value matrix
call=cor(corey,use="complete.obs",method = "pearson") # making matrix

#Significance test for correlations using Pearson method
corey.test=cor.mtest(corey,use="complete.obs",method = "pearson")


#Plotting matrix with insignificant correlations marked with a cross
corrplot(call, method = "color",
         type = "upper", order = "hclust", number.cex = .7,
         addCoef.col = "black", # Add coefficient of correlation
         tl.col = "black", tl.srt = 45, # Text label color and rotation
         # Combine with significance
         p.mat = corey.test$p, sig.level = 0.001, insig = "pch", 
         # hide correlation coefficient on the principal diagonal
         diag = FALSE)

```


### Predictor Variables  

```{r Correlation Independent Variables, message=FALSE, warning=FALSE,fig.height=8,fig.width=7,dpi=600}

#making sure all variables are numeric
full_d$Forest_Age <- as.numeric(full_d$Forest_Age)
full_d <- full_d %>%
  mutate(Wind_Exp = ifelse(Wind_Binary == "Protected",0,
                           ifelse(Wind_Binary == "Exposed",1,NA)))

#subsetting data
corey <- full_d %>%
  na.omit(.) %>%
  dplyr::select(Forest_Age,
                Elev_Mean,
                Slope,
                Wind_Exp,
                Hugo_exposure,
                Georges_exposure,
                AWS_mean,
                MAP
                ) %>%
  rename(Elevation = Elev_Mean,
         `Chronic Wind-Exposure` = Wind_Exp,
         `Available Soil Water Storage` = AWS_mean,
         `Forest Age` = Forest_Age,
         `Hugo Exposure` = Hugo_exposure,
         `Georges Exposure` = Georges_exposure,
         `Mean Annual Precipitation` = MAP)

#Creating Pearson value matrix
call=cor(corey,use="complete.obs",method = "pearson") # making matrix

#Significance test for correlations using Pearson method
corey.test=cor.mtest(corey,use="complete.obs",method = "pearson")

#Plotting matrix with insignificant correlations marked with a cross
corrplot(call, method = "color",
         type = "upper", order = "hclust", number.cex = .7,
         addCoef.col = "black", # Add coefficient of correlation
         tl.col = "black", tl.srt = 45, # Text label color and rotation
         # Combine with significance
         p.mat = corey.test$p, sig.level = 0.01, insig = "pch", 
         # hide correlation coefficient on the principal diagonal
         diag = FALSE)

```


*** 

# E) Wind Data 

```{r Wind Direction Plots, message=FALSE, warning=FALSE,fig.height=12,fig.width=14,dpi=600}

#Plot model data wind direction for entire island (windrose)
a <- gwa_data %>%
  ggplot(aes(x=center_degree,y=percentage))+
  geom_bar(stat="identity")+
  labs(title="a)",
       x="Compass Direction (Degrees)",
       y="% of Wind")+
  scale_x_continuous(breaks=seq(0,360,30))+
  scale_y_continuous(breaks=seq(0,40,10))+
  geom_hline(yintercept = 10, linetype="dashed")+
  coord_polar(theta="x",start=-0.25)+
  theme_bw()+
  theme(plot.title=element_text(colour="black",face="bold",hjust=-0.1,size=18),
        axis.title = element_blank(),
        axis.text = element_text(size=20,colour="black"),
        panel.border = element_blank(),
        panel.grid.major = element_line(size=1),
        panel.grid.minor = element_blank())

#Plot station data average wind speeds by direction for entire island (windrose)
b <- wind_summary %>%
  ggplot(aes(x=sector,y=percent,fill=Wind_Speed))+
  geom_bar(stat="identity")+
  scico::scale_fill_scico(breaks=seq(0,25,5),
                          palette = "lajolla")+
  labs(title="b)",
       x="Compass Direction (Degrees)",
       y="% of Wind",
       fill="Mean Wind Speed (m/s)")+
  scale_x_continuous(breaks=seq(0,360,30))+
  scale_y_continuous(breaks=seq(0,30,10))+
  geom_hline(yintercept = 10, linetype="dashed")+
  coord_polar(theta="x",start=-0.25)+
  theme_bw()+
  theme(plot.title=element_text(colour="black",face="bold",hjust=-0.1,size=18),
        axis.title = element_blank(),
        axis.text = element_text(size=20,colour="black"),
        panel.border = element_blank(),
        panel.grid.major = element_line(size=1),
        panel.grid.minor = element_blank())

# extract the legend from one of the plots
legend <- get_legend(
  # create some space to the left of the legend
  b+theme(legend.text = element_text(size=24),
        legend.title = element_text(size=18,face="bold"),
        legend.box.margin = ggplot2::margin(-10, 0,-10,0)
        )
)

#combine plots
fig.s1 <- cowplot::plot_grid(a+theme(legend.position = "none"),
                               b+theme(legend.position = "none"),
                           ncol=2,align="hv")+
  theme(plot.margin = ggplot2::margin(t=0,r=0.75,b=0,l=2.75,"cm"))


#output
annotate_figure(fig.s1,
                bottom = text_grob("Compass Direction (degrees)", 
                                 color = "black",
                                 face="bold",
                                 size=24,
                                 vjust=-10.5),
                left = text_grob("% Wind", 
                                 color = "black",
                                 face="bold",
                                 size=24,rot=90,
                                 vjust=0.5),
                right = legend
                )

fig.s1a <- annotate_figure(fig.s1,
                bottom = text_grob("Compass Direction (degrees)", 
                                 color = "black",
                                 face="bold",
                                 size=24,
                                 vjust=-10.5),
                left = text_grob("% Wind", 
                                 color = "black",
                                 face="bold",
                                 size=24,rot=90,
                                 vjust=0.5),
                right = legend
                )


```


*** 

# F) Maps 

```{r load maps, message=FALSE, warning=FALSE}

#Study sites for figure 1

#saving projections
wgs <- CRS("+proj=longlat +datum=WGS84")
nad <- CRS("+proj=lcc +lat_0=17.8333333333333
+lon_0=-66.4333333333333
+lat_1=18.4333333333333
+lat_2=18.0333333333333 +x_0=200000
+y_0=200000 +datum=NAD83 +units=m
+no_defs")

# Loading shapefile of 20,660 0.28ha forests with 250m minimum distance between centroids
sites <- st_as_sf(full_d,
                  coords = c("x","y"),
                  crs=nad) %>%
  na.omit(.)

#convert to wgs
sites <- st_transform(sites,wgs)

#--Field Plots

#Load plots
plots <- readOGR(dsn = plot_dir,
                 layer= "plots_2019_stpln")

#get buffer to improve polygon
plot_borders <- gBuffer(plots, byid=TRUE, width=0)

#right coordinate system
plot_borders <- spTransform(plot_borders,wgs)

#make plottable
plot_border_sf <- st_as_sf(plot_borders)


#--Weather stations

# create shapefile of weather stations
wind_sites <- station_data %>%
  distinct(Station,lon,lat)
  
wind_sites <- st_as_sf(wind_sites,
                       coords = c("lon","lat"),
                       crs=wgs)

lef_sites <- lef_wind %>%
  distinct(Station,lon,lat)

lef_sites <- st_as_sf(lef_sites,
                       coords = c("lon","lat"),
                       crs=wgs)

#--Outline of Puerto Rico

#PR Outline
outline <- readOGR(dsn=paste0(shp_dir,"/outline_PR/pr_outline_utm.shp"))

#get buffer to improve polygon
outline_borders <- gBuffer(outline, byid=TRUE, width=0)

#right coordinate system
outline_borders <- spTransform(outline_borders,wgs)

#make outlinetable
outline_border_sf <- st_as_sf(outline_borders)

#clean
rm(plot_borders,plots,outline,outline_borders)
gc()

#----#

#Precipitation map for figure 1
setwd(prec_dir)
prec <- raster("MAP.tif")
prec <- raster::projectRaster(prec,crs=wgs)
prec <- as.data.frame(prec,xy=T)

#Age map for figure 1
setwd(age_dir)
age <- raster("Forest_Age.tif")
age <- raster::projectRaster(age,crs=wgs)
age <- as.data.frame(age,xy=T)

#Topographic map for figure 1
setwd(dem_dir)
#loading elevation map
dem <- raster("DEM_30m_Proj.tif")
dem <- raster::projectRaster(dem,crs=wgs)
dem <- as.data.frame(dem,xy=T)

#Wind-exposure map for figure 1
setwd(wind_dir)
wind <- raster("WindBinary_PR_30m_15deg_500mdist.tif")
wind <- raster::projectRaster(wind,crs=wgs)
wind <- as.data.frame(wind,xy=T)


#----#

#creating sample 30m-radius sites for figure 2
sample_site <- data.frame(x=-65.8155, y=18.323) %>%
  st_as_sf(coords=c("x", "y")) %>%
  st_set_crs(wgs) %>%
  st_buffer(dist=30,
            endCapStyle = 'ROUND')

#Height map for figure 2
setwd(csc_dir)
CHM <- raster("LFDP_CHM.tif")
CHM <- raster::projectRaster(CHM,crs=wgs)
#convert to df
CHM <- as.data.frame(CHM, xy = T) %>%
  arrange(x,y)

#Rugosity map for figure 2
Rugose <- raster("LFDP_Rugosity.tif")
Rugose <- raster::projectRaster(Rugose,crs=wgs)
#convert to df
Rugose <- as.data.frame(Rugose, xy= T) %>%
  arrange(x,y)

#combine for plotting
CSC <- cbind(CHM,Rugose$LFDP_Rugosity) %>%
  rename(LFDP_Rugosity = `Rugose$LFDP_Rugosity`)

#clean
rm(CHM,Rugose)
gc()

```

## Study Sites in Puerto Rico with precipitation and forest ages

```{r Map of study sites, message=FALSE, warning=FALSE,fig.width=11,fig.height=8,dpi=600}

a <- age %>%
  filter(!is.na(Forest_Age),Forest_Age !=0,
         x< -65.58) %>%
   mutate(Forest_Age = case_when(
    Forest_Age == "1" ~ "5-16 yr",
    Forest_Age == "2" ~ "17-25 yr",
    Forest_Age == "3" ~ "26-39 yr",
    Forest_Age == "4" ~ "40-65 yr",
    Forest_Age == "5" ~ "Old Growth"
  )) %>%
  filter(!is.na(Forest_Age)) %>%
  mutate(Forest_Age = factor(Forest_Age,levels = c("5-16 yr",
                               "17-25 yr",
                               "26-39 yr",
                               "40-65 yr",
                               "Old Growth"))) %>%
  filter(!is.na(Forest_Age)) %>%
  ggplot(aes(x=x,y=y,
             fill=Forest_Age))+
  geom_tile()+
  scale_fill_manual(values=c("#920000", "#db6d00","#ffff6d","#24ff24","#009292"))+
  geom_sf(data=outline_border_sf,fill=NA,size=0.5,color="black",inherit.aes=F)+
  geom_sf(data=sites,size=0.001,alpha=0.3,color="black",fill=NA,inherit.aes = F)+
  theme_classic()+
  coord_equal()+
  coord_sf(crs = wgs)+
  scale_y_continuous(breaks=seq(17.9,18.6,0.25))+
  scale_x_continuous()+
  labs(title="a)",
       x="Lon",
       y="Lat",
       fill="Forest Age")+
  theme(plot.title=element_text(colour="black",face="bold",hjust=-0.1,size=16),
        axis.title = element_blank(),
        axis.text.y = element_text(size=18),
        axis.text.x = element_blank(),
        legend.position = "right",
        legend.text = element_text(size=14),
        legend.title = element_text(size=15),
        panel.border = element_rect(colour = "black", fill=NA))

#a

#precipitation with field plots
b <- prec %>%
  mutate(MAP = MAP *0.01) %>%
  filter(!is.na(MAP), MAP >0,x< -65.58) %>%
  ggplot(aes(x=x,y=y,
             fill=MAP))+
  geom_raster()+
  scale_fill_binned_divergingx(palette="RdYlBu",n.breaks=5,rev=F,mid=1500)+
  geom_sf(data=outline_border_sf,fill=NA,size=0.5,color="black",inherit.aes=F)+
  theme_classic()+
  coord_equal()+
  scale_y_continuous(breaks=seq(17.9,18.6,0.25))+
  scale_x_continuous()+
  #geom_sf(data=plot_border_sf,size=3,color="black",fill=NA,inherit.aes = F)+
  labs(title="b)",
       x="Lon",
       y="Lat",
       fill="Mean Annual Precipitation (mm/yr)")+
  theme(plot.title=element_text(colour="black",face="bold",hjust=-0.1,size=16),
        axis.title = element_blank(),
        axis.text = element_text(size=18),
        legend.position = "right",
        legend.text = element_text(size=14,hjust=0.5),
        legend.title = element_text(size=15),
        panel.border = element_rect(colour = "black", fill=NA))+
  ggspatial::annotation_scale(
    location = "br",
    bar_cols = c("grey60", "white"),
    text_cex = 1
  ) +
  coord_sf(crs = wgs)+
  ggspatial::annotation_north_arrow(
    location = "br", which_north = "true",
    pad_x = unit(0.4, "in"), pad_y = unit(0.4, "in"),
    style = ggspatial::north_arrow_nautical(
      fill = c("grey40", "white"),
      line_col = "grey20"
    )
  )
#b

#Join plots
Map1 <- cowplot::plot_grid(a+theme(legend.justification = c(0,1)),
                           b+theme(legend.justification = c(0,1)),
                           ncol=1,align="hv")+
  theme(plot.margin = ggplot2::margin(t=0.75,r=0.75,b=0.75,l=1,"cm"))

#output
annotate_figure(Map1)

#clean
rm(a,b,sites,plot_border_sf)
gc()

```

## Map of chronic wind-exposure
```{r Map of chronic winds, message=FALSE, warning=FALSE,fig.width=11,fig.height=8,dpi=600}

a <- dem %>%
  filter(!is.na(DEM_30m_Proj), DEM_30m_Proj >0,x< -65.58) %>%
  ggplot(aes(x=x,y=y,
             fill=DEM_30m_Proj))+
  geom_raster()+
  scale_fill_binned_divergingx(palette="Fall",n.breaks=5,rev=F,mid=600)+
  geom_sf(data=outline_border_sf,fill=NA,size=0.5,color="black",inherit.aes=F)+
  theme_classic()+
  coord_equal()+
  scale_y_continuous(breaks=seq(17.9,18.6,0.25))+
  scale_x_continuous()+
  geom_sf(data=wind_sites,size=3,color="black",fill=NA,inherit.aes = F)+
  geom_sf(data=lef_sites,size=3,color="black",fill=NA,inherit.aes = F)+
  labs(title="a)",
       x="Lon",
       y="Lat",
       fill="Elevation (m)")+
  theme(plot.title=element_text(colour="black",face="bold",hjust=-0.1,size=16),
        axis.title = element_blank(),
        axis.text.x = element_blank(),
        axis.text.y = element_text(size=18),
        legend.position = "right",
        legend.text = element_text(size=14,hjust=0.5),
        legend.title = element_text(size=15),
        panel.border = element_rect(colour = "black", fill=NA))+
  coord_sf(crs = wgs)

#a

b <- wind %>%
  filter(!is.na(WindBinary_PR_30m_15deg_500mdist), WindBinary_PR_30m_15deg_500mdist==0 | WindBinary_PR_30m_15deg_500mdist ==1,
         x< -65.58) %>%
  mutate(Wind = case_when(WindBinary_PR_30m_15deg_500mdist==0 ~ "Protected",WindBinary_PR_30m_15deg_500mdist==1 ~ "Exposed")) %>%
  mutate(Wind = factor(Wind,
                       levels=c("Protected","Exposed"))) %>%
  ggplot(aes(x=x,y=y,
             fill=Wind))+
  geom_raster()+
  scale_fill_manual(values=c("#005000","#860086"))+
  geom_sf(data=outline_border_sf,fill=NA,size=0.5,color="black",inherit.aes=F)+
  theme_classic()+
  coord_equal()+
  scale_y_continuous(breaks=seq(17.9,18.6,0.25))+
  scale_x_continuous()+
  labs(title="b)",
       x="Lon",
       y="Lat",
       fill="Chronic Wind-Exposure")+
  theme(plot.title=element_text(colour="black",face="bold",hjust=-0.1,size=16),
        axis.title = element_blank(),
        axis.text = element_text(size=18),
        legend.position = "right",
        legend.text = element_text(size=14,hjust=0.5),
        legend.title = element_text(size=15),
        panel.border = element_rect(colour = "black", fill=NA))+
  ggspatial::annotation_scale(
    location = "br",
    bar_cols = c("grey60", "white"),
    text_cex = 1
  ) +
  coord_sf(crs = wgs)+
  ggspatial::annotation_north_arrow(
    location = "br", which_north = "true",
    pad_x = unit(0.4, "in"), pad_y = unit(0.4, "in"),
    style = ggspatial::north_arrow_nautical(
      fill = c("grey40", "white"),
      line_col = "grey20"
    )
  )

#b

#Join plots
Map1.2 <- cowplot::plot_grid(a+theme(legend.justification = c(0,1)),
                           b+theme(legend.justification = c(0,1)),
                           ncol=1,align="hv")+
  theme(plot.margin = ggplot2::margin(t=0.75,r=0.75,b=0.75,l=1,"cm"))

#output
annotate_figure(Map1.2)

#clean
rm(a,b,wind,wind_sites,dem,lef_wind,lef_sites)
gc()

```




## Maps of canopy structure metrics

```{r Map of CSC, message=FALSE, warning=FALSE,fig.width=12,fig.height=12,dpi=600}


#Plot height and rugosity for bottom panel
a <- CSC %>%
  na.omit(.) %>%
  ggplot(aes(x=x,y=y,
             color=LFDP_CHM))+
  geom_point()+
  scale_color_viridis_c()+
  geom_sf(data=sample_site,size=1,color="black",fill=NA,inherit.aes = F)+
  coord_sf(crs = wgs,
           xlim=c(-65.8165,-65.8145),
           ylim=c(18.322,18.324)
           )+
  scale_x_continuous(breaks=seq(-65.8165,-65.8145,0.001))+
  scale_y_continuous(breaks=seq(18.322,18.324,0.001))+
  theme_classic()+
  labs(color="Canopy Height (m)")+
  theme(plot.title=element_blank(),
        axis.title = element_blank(),
        axis.text = element_text(size=15),
        panel.border = element_rect(colour = "black", fill=NA),
        legend.text = element_text(size=14),
        legend.title = element_text(size=15),
        legend.position = c(0.5,0.8))
  
#a

b <- CSC %>%
  na.omit(.) %>%
  ggplot(aes(x=x,y=y,
             color=LFDP_Rugosity))+
  geom_point()+
  scale_color_continuous_divergingx(palette = "PiYG",
                                   mid=3,
                                   rev = T)+
  theme_classic()+
  geom_sf(data=sample_site,size=1,color="black",fill=NA,inherit.aes = F)+
  coord_sf(crs = wgs,
           xlim=c(-65.8165,-65.8145),
           ylim=c(18.322,18.324)
           )+
  scale_x_continuous(breaks=seq(-65.8165,-65.8145,0.001))+
  scale_y_continuous(breaks=seq(18.322,18.324,0.001))+
  labs(color="Canopy Rugosity (m)")+
  theme(plot.title=element_blank(),
        axis.title = element_blank(),
        axis.text.x = element_text(size=15),
        axis.text.y =  element_blank(),
        panel.border = element_rect(colour = "black", fill=NA),
        legend.text = element_text(size=14),
        legend.title = element_text(size=15),
        legend.position = c(0.5,0.8))+
  ggspatial::annotation_scale(
    location="br",
    bar_cols = c("grey60", "white"),
    text_cex = 1
    ) +
  ggspatial::annotation_north_arrow(
    location="br",
    which_north = "true",
    pad_x = unit(0.4, "in"), pad_y = unit(0.4, "in"),
    style = ggspatial::north_arrow_nautical(
      fill = c("grey40", "white"),
      line_col = "grey20"
    )
    )
  
#b

#plot together
Map2 <- cowplot::plot_grid(a,b,
                           ncol=2,nrow=1,align="hv",axis = "bl")+
  theme(plot.margin = ggplot2::margin(t=0.75,r=2.75,b=0.75,l=0.75,"cm"))

#check
annotate_figure(Map2)


#Image for top panel
c <- readPNG(paste0(local_path,"/Figures/CSC Manuscript 1f.png")) #loading image

#turn to ggplot item
c <- CSC %>%
  na.omit(.) %>%
  ggplot(aes(x, y)) +    # Modify image file
  geom_point(col = "white") +
  xlim(- 5, 5) +
  ylim(- 5, 5) +
  theme(axis.line = element_blank(),
        axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        panel.border = element_rect(colour = "black", fill=NA)) +
  annotation_custom(rasterGrob(c, width = 1, height = 1),
                    xmin = - 4.5, xmax = 5,
                    ymin = - Inf, ymax = Inf)

#plot together
Map3 <- cowplot::plot_grid(c,Map2,
                           ncol=1,nrow=2,align="hv")+
  theme(plot.margin = ggplot2::margin(t=0.01,r=0.01,b=0.01,l=0.01,"cm"))

#output
annotate_figure(Map3)

#clean
#rm(list=ls())
#gc()

```